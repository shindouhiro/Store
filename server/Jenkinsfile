pipeline {
    agent any
    tools {
        nodejs 'node20'
    }
    
    stages {
        stage('Checkout') {
            steps {
                // æ£€å‡ºæ•´ä¸ªä»“åº“åˆ°workspace
                checkout scm
                sh 'node -v'
                sh 'npm -v'
            }
        }
        
        
        stage('Docker Build & Deploy') {
            steps {
                dir('server') {
                    sh '''
                        echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
                        echo "ğŸ§¹ æ¸…ç†ç¯å¢ƒ..."
                        rm -rf dist/
                        
                        echo "ğŸ”§ é…ç½®é•œåƒæº..."
                        npm config set registry https://registry.npmmirror.com
                        pnpm config set registry https://registry.npmmirror.com
                        
                        echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
                        pnpm install --network-timeout 300000
                        
                        echo "ğŸ”¨ ä½¿ç”¨TypeScriptç›´æ¥ç¼–è¯‘..."
                        npx tsc -p tsconfig.json
                        
                        echo "âœ… æ„å»ºå®Œæˆï¼Œæ£€æŸ¥äº§ç‰©..."
                        ls -la dist/
                    '''
                    sh '''
                        # Dockeræ„å»ºéƒ¨åˆ†
                        IMAGE_NAME="shindouhiro/storeserver"
                        VERSION=$(date +%Y%m%d-%H%M%S)
                        
                        echo "ğŸ³ å¼€å§‹Dockeræ„å»º..."
                        docker buildx create --name builder --use || docker buildx use builder
                        docker login
                        docker buildx build --platform linux/amd64,linux/arm64 --tag ${IMAGE_NAME}:${VERSION} --tag ${IMAGE_NAME}:latest --push .
                        docker buildx stop builder || true
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ Pipelineæ‰§è¡Œå®Œæˆ'
        }
        success {
            echo 'âœ… Pipelineæ‰§è¡ŒæˆåŠŸï¼'
        }
        failure {
            echo 'âŒ Pipelineæ‰§è¡Œå¤±è´¥ï¼'
        }
    }
}
